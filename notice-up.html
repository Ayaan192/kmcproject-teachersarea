<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KMC School – Notices | Teachers Area</title>
    <link rel="icon" type="image/png" href="kmc logo.png">
    <link rel="stylesheet" href="notice-up.css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>
</head>
<body>

    <header class="main-header">
        <div class="header-container">
            <div class="logo">
                <img src="kmc logo.png" alt="KMC Logo" class="logo-img">
                <span class="kmc">KMC</span> <span class="school">SCHOOL</span>
            </div>
            <div class="contact-info">
                <div class="email">info@kmcschool.edu.np</div>
                <div class="phone">01-4792016, 4792906, 4790361, 4797111</div>
            </div>
        </div>
    </header>

    <nav class="main-nav">
        <a href="dashboard.html" class="nav-item">Dashboard</a>
        <a href="attendence.html" class="nav-item">Attendance</a>
        <a href="teacher-timetable.html" class="nav-item">Timetable</a>
        <a href="notice.html" class="nav-item">Notice</a>
        <a href="notice-up.html" class="nav-item active">Update Notice</a>
        <a href="teacher-homework.html" class="nav-item">Update Homework</a>
        <a href="teacher-todo.html" class="nav-item">Todo</a>
        <a href="teacher-feedback.html" class="nav-item">Parents Complain</a>
        <a href="teacher-login.html" class="nav-item logout">Logout</a>
    </nav>

    <main class="main-content">

        <div class="welcome-section">
            <h1>School & Class Notices</h1>
            <p>Latest updates and announcements for teachers</p>
        </div>

        <section class="notice-form-section">
            <h2 id="formTitle">Create New Notice</h2>
            <form id="noticeForm" onsubmit="saveNotice(event)">
                <label for="noticeTitle">Notice Title</label>
                <input type="text" id="noticeTitle" placeholder="e.g. Holiday Notice" required>

                <label for="noticeContent">Content</label>
                <textarea id="noticeContent" rows="6" placeholder="Write the full notice here..." required></textarea>

                <label for="noticeDate">Date</label>
                <input type="date" id="noticeDate" required>

                <label for="noticeTag">Tag</label>
                <select id="noticeTag" required>
                    <option value="Important">Important</option>
                    <option value="Exam">Exam</option>
                    <option value="Event">Event</option>
                    <option value="Holiday">Holiday</option>
                    <option value="Competition">Competition</option>
                    <option value="General">General</option>
                </select>

                <div class="form-actions">
                    <button type="submit" class="save-btn" id="saveBtn">Post Notice</button>
                    <button type="button" class="cancel-btn" id="cancelBtn" style="display:none;" onclick="resetForm()">Cancel</button>
                </div>
                <div class="error" id="formErr"></div>
                <input type="hidden" id="editingId">
            </form>
        </section>

        <!-- Notices List -->
        <section class="notices-section" id="noticesList">
            <p>Loading notices...</p>
        </section>

    </main>

    <footer class="main-footer">
        <p>© KMC School, Buddhanagar, Kathmandu • All rights reserved • 2026</p>
    </footer>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDYgCaY7E0gVqoJj4Izg@s_opbAGJ12E20",
            authDomain: "kmcproject-techersarea.firebaseapp.com",
            projectId: "kmcproject-techersarea",
            storageBucket: "kmcproject-techersarea.firebasestorage.app",
            messagingSenderId: "997910909059",
            appId: "1:997910909059:web:0b439a69bc253575de8bb6"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();


        function loadNotices() {
            const list = document.getElementById('noticesList');
            list.innerHTML = '<p>Loading notices...</p>';

            db.collection('notices')
                .orderBy('createdAt', 'desc')
                .get()
                .then(snapshot => {
                    list.innerHTML = '';
                    if (snapshot.empty) {
                        list.innerHTML = '<p>No notices posted yet.</p>';
                        return;
                    }

                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const id = doc.id;

                        const card = document.createElement('div');
                        card.className = 'notice-card';
                        card.id = `card-${id}`;

                        card.innerHTML = `
                            <div class="notice-header">
                                <span class="notice-date">${data.date || 'No date'}</span>
                                <span class="notice-tag">${data.tag || 'General'}</span>
                            </div>
                            <h2>${data.title}</h2>
                            <p class="notice-content">${data.content.replace(/\n/g, '<br>')}</p>
                            <p class="notice-footer">Posted: ${data.createdAt ? new Date(data.createdAt.toDate()).toLocaleString() : 'Unknown'}</p>
                            <div class="notice-actions">
                                <button class="edit-btn" onclick="editNotice('${id}', '${data.title.replace(/'/g, "\\'")}', '${data.content.replace(/'/g, "\\'")}', '${data.date || ''}', '${data.tag || ''}')">Edit</button>
                                <button class="delete-btn" onclick="deleteNotice('${id}')">Delete</button>
                            </div>
                        `;

                        list.appendChild(card);
                    });
                })
                .catch(error => {
                    list.innerHTML = '<p>Error loading notices: ' + error.message + '</p>';
                });
        }
        function editNotice(id, title, content, date, tag) {
            document.getElementById('formTitle').textContent = 'Edit Notice';
            document.getElementById('noticeTitle').value = title;
            document.getElementById('noticeContent').value = content;
            document.getElementById('noticeDate').value = date;
            document.getElementById('noticeTag').value = tag;
            document.getElementById('editingId').value = id;
            document.getElementById('saveBtn').textContent = 'Save Changes';
            document.getElementById('cancelBtn').style.display = 'inline-block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        function saveNotice(e) {
            e.preventDefault();
            const title = document.getElementById('noticeTitle').value.trim();
            const content = document.getElementById('noticeContent').value.trim();
            const date = document.getElementById('noticeDate').value;
            const tag = document.getElementById('noticeTag').value;
            const editingId = document.getElementById('editingId').value;
            const err = document.getElementById('formErr');

            if (!title || !content || !date || !tag) {
                err.textContent = 'All fields are required';
                return;
            }

            const noticeData = {
                title,
                content,
                date,
                tag,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            let promise;
            if (editingId) {
                promise = db.collection('notices').doc(editingId).update(noticeData);
            } else {
                noticeData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                promise = db.collection('notices').add(noticeData);
            }

            promise
                .then(() => {
                    err.textContent = editingId ? 'Notice updated successfully!' : 'Notice posted successfully!';
                    err.style.color = '#28a745';
                    resetForm();
                    loadNotices();
                })
                .catch(error => {
                    err.textContent = 'Error: ' + error.message;
                });
        }

        function resetForm() {
            document.getElementById('noticeForm').reset();
            document.getElementById('formTitle').textContent = 'Create New Notice';
            document.getElementById('editingId').value = '';
            document.getElementById('saveBtn').textContent = 'Post Notice';
            document.getElementById('cancelBtn').style.display = 'none';
            document.getElementById('formErr').textContent = '';
        }

        function deleteNotice(id) {
            if (confirm('Are you sure you want to delete this notice?')) {
                db.collection('notices').doc(id).delete()
                    .then(() => {
                        alert('Notice deleted!');
                        loadNotices();
                    })
                    .catch(error => {
                        alert('Error deleting: ' + error.message);
                    });
            }
        }

        loadNotices();
    </script>

</body>
</html>